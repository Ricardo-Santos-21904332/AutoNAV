"""This file contains the WLS.py tests."""

import pytest
from autonav.WLS import wls
from numpy import array
from numpy.testing import assert_allclose


@pytest.mark.critical()
def test_wls_no_noise(default_values):
    """This test pretends to see if the algorithm is correctly implemented by setting the noise to zero."""
    # Values used in test
    sigma = 0  # Noise STD in meters
    trajectories = wls(
        default_values[0], default_values[1], default_values[2], sigma, default_values[3], default_values[4]
    )
    wls_estimated_trajectory = trajectories[0]
    wls_true_trajectory = trajectories[1]
    # With sigma zero the trajectories should be the following ones if one performs the math
    expected_estimated_trajectory = array(
        [
            [9.9999993, 10.00000109, 4.99999943],
            [11.99410737, 9.84660832, 5.00000026],
            [13.98821967, 9.69320963, 5.0000001],
            [15.98232553, 9.5398237, 4.99999836],
            [17.97643382, 9.38643074, 4.99999968],
            [19.97054326, 9.23303459, 4.99999956],
            [21.9646521, 9.07964506, 5.0000014],
            [23.95876099, 8.92624908, 4.99999957],
            [25.95287373, 8.77285377, 5.00000177],
            [27.94698079, 8.61946441, 4.99999932],
            [29.9410906, 8.46607191, 4.99999841],
            [31.93519986, 8.31266806, 4.9999981],
            [33.92930824, 8.15928434, 5.00000072],
            [35.92341455, 8.00589278, 4.99999881],
            [37.9175268, 7.85249361, 5.00000262],
            [39.91163534, 7.69910717, 5.00000394],
            [41.90574261, 7.54571382, 4.99999521],
            [43.89985363, 7.39232028, 5.00000125],
            [45.89396392, 7.23892505, 4.99999995],
            [47.88807088, 7.08553094, 5.00000089],
            [49.88217939, 6.93213604, 5.0000017],
            [51.87628775, 6.77874597, 5.00000322],
            [53.87039765, 6.62536051, 5.00000376],
            [55.86450699, 6.47196277, 4.99999727],
            [57.85861581, 6.31857072, 4.99999953],
            [59.85272479, 6.16517489, 5.00000141],
            [61.84683255, 6.011784, 4.99999849],
            [63.840942, 5.85838746, 4.9999952],
            [65.83505156, 5.70499024, 5.00000168],
            [67.82916038, 5.55160715, 5.00000364],
            [69.82326883, 5.39820926, 5.00000061],
            [71.81737836, 5.24481779, 4.99999769],
            [73.08725323, 5.1471274, 5.00000102],
            [73.54592783, 5.11184772, 4.99999896],
            [73.81100068, 5.09146225, 4.99999953],
            [73.98823774, 5.07783282, 4.99999931],
            [74.11657462, 5.06795795, 4.99999923],
            [74.46919856, 7.0366213, 5.00000053],
            [74.66895307, 8.15180161, 5.00000116],
            [74.74664887, 8.58557321, 4.99999871],
            [74.7921523, 8.83962118, 5.00000116],
            [74.82278151, 9.01061636, 4.99999962],
            [74.84504831, 9.13492322, 5.00000043],
            [74.87356775, 11.13471957, 4.99999918],
            [74.90208982, 13.13451781, 5.00000181],
            [74.93060747, 15.13431189, 4.99999676],
            [74.95912756, 17.13411298, 5.00000298],
            [74.97377337, 18.16088161, 4.99999679],
            [74.97980204, 18.58371732, 5.00000427],
            [74.98337573, 18.83447315, 5.00000047],
            [74.98579921, 19.00429541, 4.99999716],
            [74.99289411, 21.00002041, 5.00000378],
            [74.99466704, 21.50000909, 5.0000014],
            [74.9956711, 21.78125763, 4.99999718],
            [74.99633065, 21.96692738, 5.00000067],
            [74.99680316, 22.100334, 5.00000146],
            [72.99882332, 22.19022077, 4.99999944],
            [71.00084418, 22.2801133, 4.99999796],
            [69.00286548, 22.36999988, 4.99999445],
            [67.00488896, 22.4598915, 4.99999858],
            [65.00690679, 22.54978343, 5.00000481],
            [63.00892849, 22.63967282, 5.00000018],
            [61.01095089, 22.72956853, 4.99999725],
            [59.01297148, 22.8194517, 5.00000052],
            [57.01499338, 22.90934436, 5.00000593],
            [56.50695378, 22.93220145, 4.99999808],
            [56.22280291, 22.94498356, 4.99999965],
            [56.03570878, 22.95340033, 4.99999273],
            [55.90148512, 22.95944439, 4.99999855],
            [53.90148845, 22.96332133, 5.00000546],
            [51.90149337, 22.96720082, 4.9999969],
            [49.90149489, 22.97108389, 4.9999992],
            [47.9014999, 22.97496387, 5.00000036],
            [45.90150606, 22.97884676, 4.99999757],
            [43.90150838, 22.98273248, 5.00000602],
            [41.90151382, 22.98660318, 4.99999791],
            [39.90151561, 22.99048946, 5.0000006],
            [37.90151907, 22.99437042, 4.99999839],
            [36.84916721, 22.99641192, 5.00000188],
            [36.42173916, 22.99723998, 5.00000176],
            [36.16906782, 22.99773332, 4.99999836],
            [35.99823097, 22.99806255, 5.00000266],
            [33.99822799, 22.99841107, 4.99999533],
            [31.99822875, 22.99876461, 4.99999803],
            [29.99822716, 22.99912335, 5.00000105],
            [27.99822923, 22.9994715, 5.00000092],
            [26.87455734, 22.99967185, 5.00000551],
            [26.43530897, 22.99974967, 5.00000045],
            [26.17779958, 22.9997874, 4.99999764],
            [26.00439601, 22.99982579, 5.00000032],
            [25.87829325, 22.99984809, 4.99999776],
            [23.87829228, 22.99987518, 4.99999887],
            [21.8782932, 22.99990139, 4.99999841],
            [19.87829116, 22.99993049, 5.0000008],
            [17.878293, 22.99996157, 5.00000068],
            [16.84272205, 22.99997267, 4.9999995],
            [16.41826841, 22.99998017, 4.99999935],
            [16.16683176, 22.99998497, 5.00000066],
            [15.99664721, 22.99998529, 5.00000079],
            [13.99664961, 22.99998886, 5.0000021],
            [11.99999562, 22.99999507, 4.99999908],
            [11.49999717, 22.99999675, 4.99999918],
            [11.21874889, 22.99999622, 4.99999674],
            [11.03308001, 22.99999881, 4.99999958],
            [10.89967361, 22.99999976, 5.00000068],
            [10.83306658, 24.99888828, 4.99999807],
            [10.76646303, 26.99777778, 4.9999981],
            [10.69985544, 28.99667157, 5.00000229],
            [10.63325231, 30.99556035, 5.00000258],
            [10.56665131, 32.9944501, 5.00000156],
            [10.50003977, 34.99334071, 4.99999848],
            [10.43343671, 36.99223039, 5.00000194],
            [10.3668267, 38.99112273, 4.99999766],
            [10.30022817, 40.99001322, 5.00000223],
            [10.23362095, 42.98890152, 4.99999564],
            [10.16701151, 44.98779424, 4.99999428],
            [10.10040943, 46.98668598, 5.00000648],
            [10.06256659, 48.12232144, 4.99999687],
            [10.04787145, 48.56327827, 4.99999838],
            [10.03927277, 48.82143936, 4.9999978],
            [10.03347663, 48.99516167, 4.99999737],
        ]
    )
    expected_true_trajectory = array(
        [
            [10.0, 10.0, 5.0],
            [11.99410897, 9.84660697, 5.00000002],
            [13.98821794, 9.69321394, 5.00000001],
            [15.98232692, 9.53982108, 5.00000001],
            [17.97643588, 9.38642799, 5.00000006],
            [19.97054485, 9.2330349, 5.00000007],
            [21.96465382, 9.07964193, 5.00000009],
            [23.95876278, 8.92624882, 5.00000004],
            [25.95287175, 8.77285582, 5.00000005],
            [27.94698073, 8.61946291, 4.99999998],
            [29.9410897, 8.46606985, 5.00000001],
            [31.93519866, 8.31267677, 5.00000008],
            [33.92930766, 8.15928418, 5.00000017],
            [35.92341663, 8.00589117, 5.00000013],
            [37.9175256, 7.85249809, 5.00000019],
            [39.91163459, 7.69910532, 5.00000005],
            [41.90574355, 7.5457122, 4.99999983],
            [43.89985251, 7.3923191, 5.00000012],
            [45.89396148, 7.23892602, 5.00000004],
            [47.88807045, 7.08553307, 5.00000004],
            [49.88217943, 6.93214023, 4.99999998],
            [51.87628843, 6.77874754, 4.99999984],
            [53.87039741, 6.62535464, 4.99999956],
            [55.86450633, 6.47196104, 4.99999921],
            [57.85861529, 6.31856786, 4.99999949],
            [59.85272424, 6.16517455, 4.99999955],
            [61.84683321, 6.01178156, 4.99999936],
            [63.84094216, 5.85838828, 4.99999959],
            [65.83505115, 5.70499557, 5.00000045],
            [67.82916022, 5.55160383, 5.00000008],
            [69.8232691, 5.39820969, 4.99999907],
            [71.8173781, 5.24481701, 4.99999884],
            [73.08725362, 5.14713399, 4.99999976],
            [73.54592955, 5.11185289, 4.99999951],
            [73.811001, 5.09146351, 4.9999997],
            [73.98823799, 5.07782978, 4.99999977],
            [74.11657391, 5.06795716, 4.99999986],
            [74.46920095, 7.03662528, 5.00000017],
            [74.66895095, 8.1517973, 4.99999997],
            [74.74664819, 8.58557239, 4.9999997],
            [74.79215441, 8.83962779, 4.99999993],
            [74.82278199, 9.01061639, 4.99999976],
            [74.84504794, 9.13492379, 4.9999998],
            [74.87356793, 11.13472043, 4.99999973],
            [74.90208804, 13.13451708, 4.99999991],
            [74.93060759, 15.13431372, 4.99999939],
            [74.9591279, 17.13411036, 5.00000072],
            [74.97377137, 18.16087832, 4.99999965],
            [74.97980122, 18.58371586, 5.00000039],
            [74.98337733, 18.83447343, 4.99999963],
            [74.98579958, 19.00429731, 4.99999956],
            [74.9928924, 21.00001681, 5.00000098],
            [74.99466886, 21.50000976, 5.00000004],
            [74.99566879, 21.78125813, 4.99999977],
            [74.99632828, 21.96692592, 5.0000002],
            [74.99680212, 22.10033164, 5.00000012],
            [72.99882319, 22.1902217, 4.99999997],
            [71.00084429, 22.28011212, 5.00000003],
            [69.00286537, 22.37000228, 5.00000029],
            [67.00488647, 22.45989295, 5.00000108],
            [65.00690757, 22.54978344, 5.00000132],
            [63.00892865, 22.63967368, 5.00000036],
            [61.01094975, 22.72956412, 5.00000031],
            [59.01297076, 22.81945279, 5.00000123],
            [57.0149919, 22.90934421, 5.00000097],
            [56.50695371, 22.93220112, 4.99999947],
            [56.22280286, 22.9449852, 4.99999984],
            [56.03570791, 22.95340299, 4.99999989],
            [55.90148567, 22.95944205, 5.00000083],
            [53.90148944, 22.96332269, 5.00000097],
            [51.9014932, 22.96720372, 5.00000039],
            [49.90149697, 22.97108493, 5.00000076],
            [47.90150073, 22.97496589, 5.00000087],
            [45.9015045, 22.978847, 5.00000081],
            [43.90150826, 22.98272778, 5.00000126],
            [41.90151203, 22.98660746, 4.99999991],
            [39.9015158, 22.99048974, 5.00000051],
            [37.90151956, 22.99437038, 5.00000027],
            [36.84916596, 22.99641218, 5.00000085],
            [36.42173774, 22.99724155, 5.00000042],
            [36.16906948, 22.99773205, 5.0000001],
            [35.99822921, 22.99806329, 5.00000034],
            [33.99822924, 22.99841561, 4.99999986],
            [31.99822928, 22.99876878, 5.0000009],
            [29.99822931, 22.99912183, 5.00000146],
            [27.99822934, 22.99947262, 5.00000104],
            [26.87455701, 22.99967069, 5.00000069],
            [26.43531135, 22.99974758, 4.9999994],
            [26.17779737, 22.9997925, 4.99999932],
            [26.00439588, 22.9998238, 4.99999967],
            [25.87829446, 22.99984567, 4.99999963],
            [23.87829446, 22.9998736, 5.00000004],
            [21.87829446, 22.99990171, 5.0000003],
            [19.87829446, 22.99993038, 5.00000076],
            [17.87829446, 22.99995888, 5.00000043],
            [16.84272314, 22.99997271, 5.00000018],
            [16.41827007, 22.999979, 5.0000003],
            [16.16683441, 22.99998252, 5.00000041],
            [15.99664736, 22.99998471, 5.00000032],
            [13.99664736, 22.99998962, 5.00000005],
            [11.99999635, 22.99999518, 4.999999],
            [11.49999854, 22.99999642, 4.99999923],
            [11.2187496, 22.99999703, 4.99999939],
            [11.03308099, 22.9999976, 4.99999988],
            [10.8996742, 22.99999775, 4.99999994],
            [10.83306868, 24.99888837, 4.99999989],
            [10.76646328, 26.997779, 5.00000004],
            [10.69985773, 28.99666961, 5.00000021],
            [10.63325236, 30.99556024, 4.99999999],
            [10.56664676, 32.99445085, 4.99999972],
            [10.50004062, 34.99334145, 4.99999953],
            [10.4334352, 36.99223207, 4.99999974],
            [10.36682943, 38.99112268, 4.99999944],
            [10.30022441, 40.99001332, 4.99999987],
            [10.23361796, 42.9889039, 4.99999937],
            [10.16701174, 44.9877945, 5.00000061],
            [10.10040679, 46.98668514, 5.0000029],
            [10.06256516, 48.12232276, 5.00000045],
            [10.04787201, 48.56327695, 5.00000119],
            [10.03927, 48.82144131, 5.00000148],
            [10.03348112, 48.99516333, 5.0000018],
        ]
    )
    assert_allclose(expected_estimated_trajectory, wls_estimated_trajectory)
    assert_allclose(expected_true_trajectory, wls_true_trajectory)
