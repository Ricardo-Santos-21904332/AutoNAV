"""This file contains the GTRS.py tests."""

import pytest
from autonav.GTRS import gtrs
from numpy import array
from numpy.testing import assert_allclose


@pytest.mark.critical()
def test_gtrs_no_noise(default_values):
    """This test pretends to see if the algorithm is correctly implemented by setting the noise to zero."""
    # Values used in test
    sigma = 0  # Noise STD in meters
    trajectories = gtrs(
        default_values[0], default_values[1], default_values[2], sigma, default_values[3], default_values[4]
    )
    gtrs_estimated_trajectory = trajectories[0]
    gtrs_true_trajectory = trajectories[1]
    # With sigma zero the trajectories should be the following ones if one performs the math
    expected_estimated_trajectory = array(
        [
            [9.99999962, 9.99999996, 4.99999754],
            [11.99410947, 9.84660779, 5.00000705],
            [13.98821739, 9.69321436, 5.00000066],
            [15.98232633, 9.53982188, 5.0000055],
            [17.97643436, 9.38642838, 4.99999871],
            [19.97054325, 9.23303628, 5.00000696],
            [21.96465149, 9.07964328, 5.00000546],
            [23.95875955, 8.92624995, 5.00000067],
            [25.95286755, 8.77285661, 4.9999958],
            [27.94697505, 8.61946163, 4.99997503],
            [29.94108338, 8.46607013, 4.99998826],
            [31.93519126, 8.31267747, 4.99999003],
            [33.92929895, 8.15928452, 4.99998914],
            [35.92340664, 8.00589281, 4.99999963],
            [37.91751374, 7.85249744, 4.99997654],
            [39.9116211, 7.69910598, 4.9999893],
            [41.90572815, 7.5457138, 4.9999955],
            [43.89983488, 7.39231955, 4.99998327],
            [45.89394148, 7.23892688, 4.99998525],
            [47.88804782, 7.08553417, 4.99998713],
            [49.88215387, 6.93214165, 4.99999082],
            [51.87625965, 6.77874629, 4.99996981],
            [53.87036509, 6.62535413, 4.99997706],
            [55.86447021, 6.47196031, 4.99997007],
            [57.85857491, 6.31856718, 4.99996936],
            [59.85267913, 6.16517445, 4.99997222],
            [61.84678297, 6.01178011, 4.99996124],
            [63.840886, 5.858389, 4.9999783],
            [65.83498843, 5.70499653, 4.99998323],
            [67.82909036, 5.55160199, 4.99996971],
            [69.82319137, 5.39820917, 4.9999697],
            [71.81729124, 5.24481823, 4.9999832],
            [73.08723003, 5.14712919, 4.99996762],
            [73.54591463, 5.11184689, 4.9999744],
            [73.81098913, 5.09145874, 4.99999118],
            [73.98822888, 5.07782342, 4.99997626],
            [74.11656591, 5.06795347, 4.99999324],
            [74.46919408, 7.03661852, 4.99998351],
            [74.66894447, 8.1517932, 4.99999847],
            [74.74664366, 8.5855722, 4.99999806],
            [74.79215043, 8.83962841, 5.00000283],
            [74.82277761, 9.0106157, 5.00001079],
            [74.84504439, 9.13492198, 4.99999641],
            [74.87356498, 11.13471714, 4.99999037],
            [74.90208546, 13.13451276, 4.99998951],
            [74.93060606, 15.13430836, 4.99998812],
            [74.95912607, 17.13410477, 4.99999868],
            [74.97377036, 18.16087768, 4.99999037],
            [74.97980012, 18.5837176, 5.00000263],
            [74.98337668, 18.8344748, 4.99999919],
            [74.98579943, 19.00429746, 4.99998899],
            [74.99289167, 21.00001427, 4.99999286],
            [74.99466774, 21.50001083, 5.00000577],
            [74.9956666, 21.7812591, 5.00001546],
            [74.99632775, 21.96692558, 4.99999936],
            [74.99680194, 22.10033171, 4.99999915],
            [72.9988327, 22.19022398, 5.00000564],
            [71.00086184, 22.28011658, 5.00002381],
            [69.00289079, 22.3700082, 5.00003193],
            [67.00491894, 22.45989956, 5.00004141],
            [65.00694724, 22.54978924, 5.00003101],
            [63.00897432, 22.63967956, 5.00003585],
            [61.01100172, 22.72956735, 5.00000958],
            [59.01302789, 22.81945661, 5.00001108],
            [57.01505368, 22.90934483, 5.00000514],
            [56.50698593, 22.93220394, 5.00002534],
            [56.22282383, 22.94498698, 5.00000759],
            [56.03572281, 22.95340496, 5.00001401],
            [55.90149731, 22.95944332, 5.00000908],
            [53.90150535, 22.96332427, 5.00000495],
            [51.9015129, 22.96720617, 5.00001594],
            [49.9015202, 22.97108698, 5.00001291],
            [47.90152719, 22.97496818, 5.00001688],
            [45.9015338, 22.97884836, 5.00000755],
            [43.9015403, 22.98272962, 5.0000147],
            [41.90154672, 22.98661097, 5.00002434],
            [39.90155243, 22.99049038, 5.00000717],
            [37.9015584, 22.99437128, 5.00001256],
            [36.84917737, 22.99641308, 5.00001178],
            [36.42174465, 22.99724187, 5.00000419],
            [36.16907544, 22.99773346, 5.00002445],
            [35.99823242, 22.99806347, 5.00000277],
            [33.99823364, 22.99841505, 4.99999279],
            [31.99823594, 22.99876851, 5.00001216],
            [29.99823636, 22.99911947, 4.99999257],
            [27.99823743, 22.99947184, 4.9999955],
            [26.87456153, 22.99967149, 5.00002584],
            [26.43531346, 22.99974791, 5.00001031],
            [26.17779806, 22.99979318, 5.0000093],
            [26.00439712, 22.99982364, 5.00000802],
            [25.87829565, 22.99984591, 5.00000922],
            [23.87829635, 22.99987405, 5.00000446],
            [21.87829837, 22.99990305, 5.00001575],
            [19.87829775, 22.99993053, 4.99999766],
            [17.87829817, 22.99995894, 4.99999709],
            [16.84272206, 22.99997327, 4.99998799],
            [16.41827174, 22.9999803, 5.0000108],
            [16.16683478, 22.99998372, 5.00000745],
            [15.99664643, 22.99998595, 5.00000291],
            [13.9966477, 22.99999081, 5.00000694],
            [11.99999902, 22.99999535, 5.00000285],
            [11.5000011, 22.99999678, 5.00001039],
            [11.21874663, 22.99999662, 4.99998552],
            [11.03308203, 22.99999772, 5.00000578],
            [10.89967246, 22.99999761, 4.99999256],
            [10.83306671, 24.99888797, 4.99999069],
            [10.76646263, 26.99777852, 4.99999727],
            [10.69985761, 28.99666889, 4.99999882],
            [10.63325055, 30.995559, 4.99999039],
            [10.56664504, 32.99444925, 4.99998966],
            [10.50004, 34.99333949, 4.99999106],
            [10.43343417, 36.99222964, 4.99998899],
            [10.36682757, 38.99111969, 4.9999837],
            [10.30022363, 40.99000987, 4.99999026],
            [10.23362179, 42.9889001, 5.00000569],
            [10.16701067, 44.98778982, 4.99998245],
            [10.10040634, 46.98667981, 4.99998839],
            [10.06256885, 48.12232177, 5.00000395],
            [10.04787528, 48.56327566, 5.00000293],
            [10.03927281, 48.82144089, 5.00000314],
            [10.03348072, 48.99516226, 4.99998951],
        ]
    )
    expected_true_trajectory = array(
        [
            [10.0, 10.0, 5.0],
            [11.99410897, 9.846607, 5.00000008],
            [13.98821794, 9.69321398, 4.99999985],
            [15.98232691, 9.53982097, 4.99999983],
            [17.97643588, 9.38642795, 4.99999964],
            [19.97054485, 9.23303494, 4.99999969],
            [21.96465382, 9.0796419, 4.99999944],
            [23.95876279, 8.92624886, 4.99999923],
            [25.95287175, 8.77285584, 4.99999921],
            [27.94698072, 8.61946283, 4.99999938],
            [29.9410897, 8.46606991, 5.00000044],
            [31.93519867, 8.31267693, 5.00000095],
            [33.92930765, 8.15928394, 5.00000142],
            [35.92341662, 8.00589095, 5.00000194],
            [37.91752558, 7.8524979, 5.00000196],
            [39.91163456, 7.69910498, 5.00000322],
            [41.90574353, 7.54571199, 5.00000383],
            [43.8998525, 7.39231895, 5.0000041],
            [45.89396148, 7.23892601, 5.00000518],
            [47.88807045, 7.08553306, 5.00000619],
            [49.88217942, 6.93214011, 5.00000713],
            [51.8762884, 6.77874714, 5.00000786],
            [53.87039739, 6.62535439, 5.00001047],
            [55.86450638, 6.47196162, 5.00001263],
            [57.85861538, 6.31856899, 5.00001575],
            [59.85272438, 6.16517645, 5.00001931],
            [61.84683339, 6.01178399, 5.00002297],
            [63.84094243, 5.85839187, 5.00002885],
            [65.83505146, 5.70499965, 5.00003272],
            [67.82916051, 5.55160759, 5.00003637],
            [69.82326962, 5.39821638, 5.00004479],
            [71.81737879, 5.24482601, 5.00005647],
            [73.08732364, 5.14714015, 5.00006317],
            [73.5460107, 5.1118582, 5.00007093],
            [73.81108694, 5.09146878, 5.0000756],
            [73.98832732, 5.07783545, 5.00007692],
            [74.11666539, 5.06796394, 5.00007993],
            [74.46929549, 7.03663151, 5.00008263],
            [74.66904742, 8.15180589, 5.00008883],
            [74.74674708, 8.58558522, 5.00008919],
            [74.7922543, 8.83964114, 5.00008954],
            [74.82288197, 9.01062769, 5.00008912],
            [74.84514844, 9.13493534, 5.00008777],
            [74.87366915, 11.13473197, 5.00008843],
            [74.90218988, 13.1345286, 5.0000906],
            [74.93071067, 15.13432523, 5.00009366],
            [74.95923155, 17.13412186, 5.00009854],
            [74.97387559, 18.16089571, 5.00009901],
            [74.97990614, 18.58373507, 5.00010123],
            [74.98348259, 18.83449255, 5.00010076],
            [74.9859047, 19.00431594, 5.00010088],
            [74.9929974, 21.0000334, 5.00010638],
            [74.99477449, 21.50002942, 5.00010816],
            [74.99577428, 21.78127714, 5.00010708],
            [74.99643445, 21.96694448, 5.00010473],
            [74.99690867, 22.10035067, 5.00010481],
            [72.99892975, 22.19024096, 5.00010489],
            [71.00095083, 22.28013098, 5.00010427],
            [69.00297189, 22.37002063, 5.00010129],
            [67.00499293, 22.45990995, 5.00009674],
            [65.00701396, 22.54979888, 5.00008985],
            [63.00903497, 22.6396876, 5.00008365],
            [61.01105597, 22.72957584, 5.00007471],
            [59.01307697, 22.81946415, 5.00007153],
            [57.01509794, 22.90935187, 5.00006601],
            [56.50702938, 22.93220934, 5.00006471],
            [56.22286643, 22.94499322, 5.00005993],
            [56.03576511, 22.95341063, 5.00005877],
            [55.90153927, 22.95944918, 5.00005696],
            [53.90154304, 22.96332991, 5.00005609],
            [51.9015468, 22.96721063, 5.00005556],
            [49.90155057, 22.9710912, 5.00005368],
            [47.90155433, 22.97497174, 5.00005194],
            [45.90155809, 22.97885217, 5.00004933],
            [43.90156186, 22.98273266, 5.00004794],
            [41.90156562, 22.98661296, 5.00004464],
            [39.90156939, 22.99049296, 5.00003758],
            [37.90157315, 22.9943732, 5.00003466],
            [36.84919103, 22.99641472, 5.0000301],
            [36.42175811, 22.99724383, 5.00002738],
            [36.1690879, 22.997734, 5.00002664],
            [35.99824541, 22.99806522, 5.00002306],
            [33.99824544, 22.99841737, 5.00002256],
            [31.99824547, 22.99876965, 5.00002416],
            [29.9982455, 22.99912159, 5.00002069],
            [27.99824553, 22.99947393, 5.00002366],
            [26.87456705, 22.99967187, 5.00002535],
            [26.43531943, 22.99974885, 5.00001929],
            [26.17780384, 22.99979408, 5.00001744],
            [26.0044028, 22.99982453, 5.00001607],
            [25.8783011, 22.99984667, 5.00001506],
            [23.8783011, 22.999875, 5.00001337],
            [21.8783011, 22.99990337, 5.00001237],
            [19.8783011, 22.99993156, 5.00000779],
            [17.8783011, 22.99996004, 5.00000875],
            [16.84272606, 22.99997481, 5.00000979],
            [16.41827299, 22.99998097, 5.00001256],
            [16.16683614, 22.99998446, 5.00001064],
            [15.99664822, 22.99998684, 5.00000956],
            [13.99664822, 22.99999152, 5.00000859],
            [11.99999911, 22.99999611, 5.00000512],
            [11.4999996, 22.99999728, 5.0000044],
            [11.21874919, 22.99999788, 5.00000245],
            [11.03308127, 22.9999984, 5.00000466],
            [10.89967396, 22.99999869, 5.00000391],
            [10.83306852, 24.99888931, 5.00000446],
            [10.76646312, 26.99777993, 5.00000521],
            [10.6998576, 28.99667055, 5.00000545],
            [10.63325203, 30.99556117, 5.00000556],
            [10.56664662, 32.99445179, 5.00000657],
            [10.50004122, 34.99334241, 5.00000779],
            [10.43343578, 36.99223304, 5.00000898],
            [10.3668304, 38.99112366, 5.00001067],
            [10.30022524, 40.99001429, 5.00001363],
            [10.23361982, 42.98890491, 5.00001579],
            [10.16701338, 44.9877955, 5.00001417],
            [10.10040881, 46.98668615, 5.00002117],
            [10.06256827, 48.12232838, 5.00002554],
            [10.0478746, 48.56328243, 5.00002461],
            [10.03927188, 48.82144775, 5.00002409],
            [10.033483, 48.99516932, 5.00002363],
        ]
    )
    assert_allclose(expected_estimated_trajectory, gtrs_estimated_trajectory)
    assert_allclose(expected_true_trajectory, gtrs_true_trajectory)
